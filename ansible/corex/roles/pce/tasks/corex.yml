---
- name: Create ilo-pce group
  ansible.builtin.group:
    name: ilo-pce
    state: present

- name: Create ilo-pce user
  ansible.builtin.user:
    name: ilo-pce
    group: ilo-pce
    shell: /sbin/nologin

- name: Create directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    recurse: yes
    owner: ilo-pce
    group: ilo-pce
  with_items: ["/opt/illumio-pce", "/var/log/illumio-pce/", "/var/lib/illumio-pce/", "/var/lib/illumio-pce/cert", "/var/lib/illumio-pce/data", "/var/lib/illumio-pce/keys", "/var/lib/illumio-pce/runtime", "/var/lib/illumio-pce/tmp", "/etc/illumio-pce"]

- name: Untar the CoreX tarball
  unarchive:
    remote_src: no
    src: "{{ corex_file }}"
    dest: /opt/illumio-pce
  become: yes
  become_user: ilo-pce
  args:
    creates: /opt/illumio-pce/illumio-pce-ctl
  tags:
    - untar

- name: Recursively change ownership of /opt/illumio-pce directory
  ansible.builtin.file:
    path: /opt/illumio-pce
    state: directory
    recurse: yes
    owner: ilo-pce
    group: ilo-pce

- name: Copy private key
  copy:
    src: ./server.key
    dest: /var/lib/illumio-pce/cert/server.key
    owner: ilo-pce
    group: ilo-pce
    mode: "0400"

- name: Copy cert
  copy:
    src: ./server.crt
    dest: /var/lib/illumio-pce/cert/server.crt
    owner: ilo-pce
    group: ilo-pce
    mode: "0400"

- name: Get public IP
  ipify_facts:
    api_url: https://api.ipify.org
  register: public_ip

- name: Copy runtime_env.yml template to PCE
  template:
    src: ./runtime_env.yml.j2
    dest: /etc/illumio-pce/runtime_env.yml
    owner: ilo-pce
    group: ilo-pce

- name: Run illumio-pce-env check before starting cluster
  command: /opt/illumio-pce/illumio-pce-env check
  become: yes
  become_user: ilo-pce
  args:
    chdir: /tmp/

- name: Run illumio-pce-env status to make sure its not running already
  command: /opt/illumio-pce/illumio-pce-ctl status -x
  become: yes
  become_user: ilo-pce
  register: pce_status
  failed_when: pce_status.rc == 2 or  pce_status.rc > 3
  args:
    chdir: /tmp/

- name: Start PCE at runlevel 1
  command: /opt/illumio-pce/illumio-pce-ctl start -d --yes-to-db-upgrade --runlevel 1
  become: yes
  become_user: ilo-pce
  register: start_followers
  until: start_followers.rc == 0
  retries: 1
  args:
    chdir: /tmp/

- name: Wait for the PCE to start
  command: /opt/illumio-pce/illumio-pce-ctl status -w 180
  become: yes
  become_user: ilo-pce
  register: command_result
  until: command_result.rc == 1
  failed_when: command_result.rc == 0 or 'STOPPED' in command_result.stdout
  retries: 1
  args:
    chdir: /tmp/

- name: Set up DB
  command: /opt/illumio-pce/illumio-pce-db-management setup
  become: yes
  become_user: ilo-pce
  args:
    chdir: /tmp/

- name: Set to runlevel 5
  command: /opt/illumio-pce/illumio-pce-ctl set-runlevel 5
  become: yes
  become_user: ilo-pce
  args:
    chdir: /tmp/

- name: Wait for the PCE to start
  command: /opt/illumio-pce/illumio-pce-ctl status -w 180
  become: yes
  become_user: ilo-pce
  register: command_result
  until: command_result.rc == 1
  failed_when: command_result.rc == 0 or 'STOPPED' in command_result.stdout
  retries: 1
  args:
    chdir: /tmp/

- name: Create org and adding first user
  command: /opt/illumio-pce/illumio-pce-db-management create-domain --user-name brian.pitta@Illumio.com --full-name Brian Pitta --org-name CoreX Demo
  environment:
    ILO_PASSWORD: Illumio123
  become: yes
  become_user: ilo-pce
  ignore_errors: True
  args:
    chdir: /tmp/

